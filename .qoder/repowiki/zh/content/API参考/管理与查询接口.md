# 管理与查询接口

<cite>
**本文档中引用的文件**
- [API_DOCUMENTATION.md](file://API_DOCUMENTATION.md)
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java)
- [PhotoDTO.java](file://src/main/java/com/photo/dto/PhotoDTO.java)
- [ApiResponse.java](file://src/main/java/com/photo/dto/ApiResponse.java)
- [Photo.java](file://src/main/java/com/photo/entity/Photo.java)
- [PhotoControllerTest.java](file://src/test/java/com/photo/controller/PhotoControllerTest.java)
- [application.yml](file://src/main/resources/application.yml)
</cite>

## 目录
1. [简介](#简介)
2. [统一响应格式](#统一响应格式)
3. [接口概览](#接口概览)
4. [详细接口文档](#详细接口文档)
5. [PhotoDTO字段说明](#photodto字段说明)
6. [分页查询详解](#分页查询详解)
7. [权限控制与安全](#权限控制与安全)
8. [使用示例](#使用示例)
9. [常见问题解答](#常见问题解答)

## 简介

本文档详细介绍了照片管理系统的核心管理与查询接口，涵盖照片信息获取、列表查询、搜索和删除功能。系统提供了RESTful API设计，支持多种查询方式和灵活的权限控制机制。

## 统一响应格式

所有API接口均采用统一的响应格式，确保客户端能够一致地处理各种响应：

```json
{
  "code": 200,
  "message": "操作成功",
  "data": {...},
  "timestamp": 1704110400000
}
```

**状态码说明：**
- `200`: 成功
- `400`: 请求参数错误
- `403`: 访问被拒绝
- `404`: 资源不存在
- `500`: 服务器内部错误
- `507`: 存储空间不足

**Section sources**
- [API_DOCUMENTATION.md](file://API_DOCUMENTATION.md#L10-L28)
- [ApiResponse.java](file://src/main/java/com/photo/dto/ApiResponse.java#L10-L33)

## 接口概览

| 接口名称 | 方法 | 路径 | 功能描述 |
|---------|------|------|----------|
| 获取单个照片信息 | GET | `/photos/{id}` | 根据ID获取照片详细信息 |
| 用户照片列表 | GET | `/photos/user/{userId}` | 分页查询用户上传的照片 |
| 公开照片列表 | GET | `/photos/public` | 分页查询所有公开照片 |
| 关键词搜索 | GET | `/photos/search` | 根据关键词搜索照片 |
| 软删除照片 | DELETE | `/photos/{id}` | 软删除照片（标记删除） |
| 永久删除照片 | DELETE | `/photos/{id}/permanent` | 物理删除照片及文件 |

## 详细接口文档

### 1. 获取单个照片信息

**接口地址**: `GET /photos/{id}`

**功能描述**: 根据照片ID获取详细的照片信息，包括访问统计、文件信息等。

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 照片ID（路径参数） |

**响应结构**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "id": 1,
    "originalFilename": "photo.jpg",
    "fileSize": 1024000,
    "fileSizeReadable": "1.00 MB",
    "contentType": "image/jpeg",
    "url": "/api/photos/view/abc123def456.jpg",
    "thumbnailUrl": "/api/photos/thumbnail/abc123def456.jpg",
    "downloadUrl": "/api/photos/download/abc123def456.jpg",
    "width": 1920,
    "height": 1080,
    "accessCount": 10,
    "downloadCount": 5,
    "isPublic": true,
    "description": "我的照片",
    "createdAt": "2024-01-01T12:00:00",
    "updatedAt": "2024-01-01T12:00:00",
    "lastAccessedAt": "2024-01-01T13:00:00"
  },
  "timestamp": 1704110400000
}
```

**错误响应**:
- `404`: 照片不存在或已被软删除
- `500`: 服务器内部错误

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L230-L237)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L141-L151)

### 2. 获取用户照片列表

**接口地址**: `GET /photos/user/{userId}`

**功能描述**: 分页查询指定用户上传的所有照片，支持软删除过滤。

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | 是 | 用户ID（路径参数） |

**查询参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | Integer | 否 | 0 | 页码，从0开始 |
| size | Integer | 否 | 20 | 每页数量 |

**响应结构**:
```json
{
  "code": 200,
  "message": "操作成功",
  "data": {
    "content": [...],
    "pageable": {...},
    "totalPages": 5,
    "totalElements": 100,
    "size": 20,
    "number": 0
  },
  "timestamp": 1704110400000
}
```

**分页响应结构说明**:
- `content`: 当前页的数据列表
- `totalPages`: 总页数
- `totalElements`: 总元素数量
- `size`: 每页大小
- `number`: 当前页码（从0开始）

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L242-L251)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L165-L168)

### 3. 获取公开照片列表

**接口地址**: `GET /photos/public`

**功能描述**: 分页查询所有公开的照片，支持软删除过滤。

**查询参数**:
| 参数名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| page | Integer | 否 | 0 | 页码，从0开始 |
| size | Integer | 否 | 20 | 每页数量 |

**响应结构**: 与用户照片列表相同，返回所有公开的照片列表。

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L256-L264)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L174-L178)

### 4. 关键词搜索

**接口地址**: `GET /photos/search`

**功能描述**: 根据关键词搜索照片文件名，支持模糊匹配。

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| keyword | String | 是 | 搜索关键词 |
| page | Integer | 否 | 页码，从0开始，默认0 |
| size | Integer | 否 | 每页数量，默认20 |

**搜索规则**:
- 支持文件名部分匹配
- 忽略大小写
- 支持多个关键词组合搜索

**使用示例**:
```
GET /photos/search?keyword=vacation&page=0&size=10
```

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L269-L278)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L183-L187)

### 5. 软删除照片

**接口地址**: `DELETE /photos/{id}`

**功能描述**: 软删除照片，不会立即删除文件，而是标记为已删除状态。

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 照片ID（路径参数） |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | 是 | 用户ID（查询参数） |

**权限要求**:
- 只有照片的拥有者才能删除
- 非法访问会抛出403错误

**删除流程**:
1. 验证照片是否存在且未被软删除
2. 验证用户权限
3. 将`deleted`字段设置为`true`
4. 更新数据库记录

**响应示例**:
```json
{
  "code": 200,
  "message": "删除成功",
  "data": null,
  "timestamp": 1704110400000
}
```

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L283-L291)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L192-L205)

### 6. 永久删除照片

**接口地址**: `DELETE /photos/{id}/permanent`

**功能描述**: 物理删除照片及其相关文件，不可恢复。

**路径参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 照片ID（路径参数） |

**查询参数**:
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | String | 是 | 用户ID（查询参数） |

**删除流程**:
1. 验证照片是否存在且未被软删除
2. 验证用户权限
3. 删除存储在服务器上的原始文件
4. 删除生成的缩略图文件
5. 从数据库中删除记录

**权限要求**: 与软删除相同，只有照片拥有者可以执行

**响应示例**:
```json
{
  "code": 200,
  "message": "永久删除成功",
  "data": null,
  "timestamp": 1704110400000
}
```

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L296-L304)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L208-L234)

## PhotoDTO字段说明

PhotoDTO是照片信息的主要数据传输对象，包含以下字段：

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 照片唯一标识符 |
| originalFilename | String | 原始文件名 |
| fileSize | Long | 文件大小（字节） |
| fileSizeReadable | String | 可读格式的文件大小（如"1.00 MB"） |
| contentType | String | MIME类型（如"image/jpeg"） |
| url | String | 原图访问URL |
| thumbnailUrl | String | 缩略图URL |
| downloadUrl | String | 下载URL |
| width | Integer | 图片宽度（像素） |
| height | Integer | 图片高度（像素） |
| accessCount | Long | 访问次数 |
| downloadCount | Long | 下载次数 |
| isPublic | Boolean | 是否公开 |
| description | String | 照片描述 |
| createdAt | LocalDateTime | 创建时间 |
| updatedAt | LocalDateTime | 更新时间 |
| lastAccessedAt | LocalDateTime | 最后访问时间 |

**Section sources**
- [PhotoDTO.java](file://src/main/java/com/photo/dto/PhotoDTO.java#L18-L103)

## 分页查询详解

### 分页参数说明

所有支持分页的接口都遵循相同的分页参数规范：

- **page**: 页码，从0开始计数
- **size**: 每页显示的数量，默认20，最大值由系统配置决定

### 分页响应结构

分页响应包含以下核心字段：

```json
{
  "content": [],          // 当前页的数据列表
  "totalPages": 5,        // 总页数
  "totalElements": 100,   // 总元素数量
  "size": 20,             // 每页大小
  "number": 0             // 当前页码（从0开始）
}
```

### 分页最佳实践

1. **合理设置页面大小**: 避免一次性加载过多数据
2. **使用适当的排序**: 默认按创建时间倒序排列
3. **前端缓存**: 对于频繁访问的数据，考虑本地缓存
4. **懒加载**: 对于长列表，实现无限滚动加载

**Section sources**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L165-L178)

## 权限控制与安全

### 软删除与永久删除的区别

| 特性 | 软删除 | 永久删除 |
|------|--------|----------|
| 数据保留 | 数据仍保留在数据库中 | 数据完全删除 |
| 文件处理 | 不删除文件 | 删除服务器文件 |
| 可恢复性 | 可通过恢复功能找回 | 不可恢复 |
| 性能影响 | 影响查询性能 | 提升查询性能 |
| 存储占用 | 占用存储空间 | 释放存储空间 |

### 权限验证机制

1. **用户身份验证**: 通过`userId`参数验证操作权限
2. **资源所有权检查**: 确保用户只能操作自己的照片
3. **访问控制**: 防止未授权访问私有资源

### 安全措施

- **文件类型验证**: 使用Apache Tika进行MIME类型检测
- **文件大小限制**: 单文件最大10MB
- **防盗链保护**: 可配置允许的Referer域名列表
- **路径遍历防护**: 严格验证文件名，防止目录遍历攻击
- **XSS防护**: 对所有输入进行HTML转义

**Section sources**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L198-L201)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L216-L219)

## 使用示例

### JavaScript Fetch示例

```javascript
// 获取单个照片信息
async function getPhotoInfo(photoId) {
  const response = await fetch(`/api/photos/${photoId}`);
  const result = await response.json();
  return result.data;
}

// 获取用户照片列表
async function getUserPhotos(userId, page = 0, size = 20) {
  const response = await fetch(
    `/api/photos/user/${userId}?page=${page}&size=${size}`
  );
  const result = await response.json();
  return result.data;
}

// 搜索照片
async function searchPhotos(keyword, page = 0, size = 20) {
  const response = await fetch(
    `/api/photos/search?keyword=${encodeURIComponent(keyword)}&page=${page}&size=${size}`
  );
  const result = await response.json();
  return result.data;
}

// 软删除照片
async function deletePhoto(photoId, userId) {
  const response = await fetch(`/api/photos/${photoId}?userId=${userId}`, {
    method: 'DELETE'
  });
  const result = await response.json();
  return result;
}
```

### cURL示例

```bash
# 获取单个照片信息
curl -X GET "http://localhost:8080/api/photos/1"

# 获取用户照片列表
curl -X GET "http://localhost:8080/api/photos/user/user123?page=0&size=10"

# 搜索照片
curl -X GET "http://localhost:8080/api/photos/search?keyword=vacation&page=0&size=10"

# 软删除照片
curl -X DELETE "http://localhost:8080/api/photos/1?userId=user123"

# 永久删除照片
curl -X DELETE "http://localhost:8080/api/photos/1/permanent?userId=user123"
```

**Section sources**
- [PhotoControllerTest.java](file://src/test/java/com/photo/controller/PhotoControllerTest.java#L83-L173)

## 常见问题解答

### Q1: 如何判断照片是否被软删除？

**A**: 查询照片信息时，如果返回404错误，则可能是照片已被软删除。可以通过检查数据库中`deleted`字段来确认。

### Q2: 软删除后的照片还能访问吗？

**A**: 不能直接访问。软删除后，照片会被标记为已删除状态，在查询时会被过滤掉。

### Q3: 搜索功能支持哪些关键词？

**A**: 支持文件名的部分匹配，包括：
- 完整文件名
- 文件名的一部分
- 包含特殊字符的文件名

### Q4: 删除操作会影响其他用户吗？

**A**: 不会。每次删除操作都需要提供正确的`userId`参数，系统会验证操作权限。

### Q5: 如何处理大量数据的分页？

**A**: 建议：
1. 设置合理的`size`值（建议20-50）
2. 实现前端分页控件
3. 对于大数据集，考虑添加额外的筛选条件

### Q6: 删除操作的性能如何？

**A**: 
- 软删除：O(1)复杂度，仅更新数据库记录
- 永久删除：O(n)复杂度，需要删除文件和数据库记录

**Section sources**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L146-L148)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L203-L204)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L231-L233)