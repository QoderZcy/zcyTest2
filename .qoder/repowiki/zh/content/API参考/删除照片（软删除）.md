# 删除照片（软删除）

<cite>
**本文档中引用的文件**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java)
- [PhotoRepository.java](file://src/main/java/com/photo/repository/PhotoRepository.java)
- [Photo.java](file://src/main/java/com/photo/entity/Photo.java)
- [AccessDeniedException.java](file://src/main/java/com/photo/exception/AccessDeniedException.java)
- [ApiResponse.java](file://src/main/java/com/photo/dto/ApiResponse.java)
- [PhotoControllerTest.java](file://src/test/java/com/photo/controller/PhotoControllerTest.java)
</cite>

## 目录
1. [接口概述](#接口概述)
2. [技术规范](#技术规范)
3. [权限验证机制](#权限验证机制)
4. [业务流程分析](#业务流程分析)
5. [响应格式说明](#响应格式说明)
6. [错误处理](#错误处理)
7. [使用示例](#使用示例)
8. [最佳实践](#最佳实践)
9. [故障排除](#故障排除)

## 接口概述

### 功能描述
PhotoController中的deletePhoto接口实现了照片的软删除功能。该接口采用RESTful设计，支持通过HTTP DELETE方法删除指定ID的照片记录。软删除机制确保数据的安全性和可恢复性，不会立即物理删除存储的文件。

### 核心特性
- **软删除机制**：仅将照片标记为已删除状态（设置deleted=true），不立即删除物理文件
- **权限控制**：严格验证用户身份，只有照片所有者才能执行删除操作
- **事务保证**：操作具有原子性，确保数据一致性
- **缓存更新**：自动清除相关缓存以保持数据同步

## 技术规范

### HTTP方法与URL
- **HTTP方法**：DELETE
- **URL模式**：`/photos/{id}`
- **路径参数**：
  - `id` (Long): 照片唯一标识符，必需参数
- **查询参数**：
  - `userId` (String): 用户ID，必需参数

### 请求格式
```http
DELETE /photos/123?userId=testUser123 HTTP/1.1
Host: api.example.com
Authorization: Bearer <token>
Content-Type: application/json
```

### 响应格式
接口返回统一的JSON格式响应，包含状态码、消息和时间戳信息。

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L275-L285)
- [ApiResponse.java](file://src/main/java/com/photo/dto/ApiResponse.java#L1-L63)

## 权限验证机制

### 验证流程
系统实施严格的权限验证机制，确保只有照片所有者才能删除其拥有的照片。

```mermaid
flowchart TD
Start([接收删除请求]) --> ValidateParams["验证参数<br/>ID和userId"]
ValidateParams --> FindPhoto["查询照片记录"]
FindPhoto --> PhotoExists{"照片是否存在?"}
PhotoExists --> |否| Return404["返回404错误<br/>照片不存在"]
PhotoExists --> |是| CheckOwner["验证用户权限<br/>userId匹配检查"]
CheckOwner --> IsOwner{"是否为照片所有者?"}
IsOwner --> |否| Return403["返回403错误<br/>无权删除"]
IsOwner --> |是| SoftDelete["执行软删除<br/>设置deleted=true"]
SoftDelete --> ClearCache["清除缓存"]
ClearCache --> ReturnSuccess["返回成功响应"]
Return404 --> End([结束])
Return403 --> End
ReturnSuccess --> End
```

**图表来源**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L220-L240)
- [PhotoRepository.java](file://src/main/java/com/photo/repository/PhotoRepository.java#L85-L87)

### 权限验证逻辑
1. **参数验证**：确认ID和userId参数的有效性
2. **记录查询**：从数据库检索指定ID的照片记录
3. **存在性检查**：验证照片记录是否存在
4. **所有权验证**：比较请求中的userId与照片记录中的userId
5. **权限授予**：只有当两者匹配时才允许删除操作

**Section sources**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L220-L240)

## 业务流程分析

### 软删除机制
软删除是本系统的核心设计理念，提供了以下优势：

```mermaid
sequenceDiagram
participant Client as 客户端
participant Controller as PhotoController
participant Service as PhotoService
participant Repo as PhotoRepository
participant Cache as 缓存系统
Client->>Controller : DELETE /photos/{id}?userId={userId}
Controller->>Service : deletePhoto(id, userId)
Service->>Repo : findById(id)
Repo-->>Service : Photo对象
Service->>Service : 验证权限
Service->>Repo : softDeleteById(id)
Repo-->>Service : 更新结果
Service->>Cache : 清除缓存
Service-->>Controller : 操作完成
Controller->>Controller : 构建成功响应
Controller-->>Client : {code : 200, message : "删除成功"}
Note over Client,Cache : 数据被标记为已删除但保留<br/>物理文件仍保留在服务器上
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L275-L285)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L220-L240)
- [PhotoRepository.java](file://src/main/java/com/photo/repository/PhotoRepository.java#L85-L87)

### 生命周期管理
软删除机制在照片生命周期管理中发挥关键作用：

| 阶段 | 操作 | 影响 |
|------|------|------|
| 创建 | 新增照片记录 | 设置deleted=false |
| 使用 | 访问/下载 | 增加访问计数 |
| 删除 | 软删除操作 | 设置deleted=true |
| 恢复 | 重新启用 | 设置deleted=false |
| 清理 | 定期清理 | 物理删除过期记录 |

**Section sources**
- [Photo.java](file://src/main/java/com/photo/entity/Photo.java#L95-L97)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L220-L240)

## 响应格式说明

### 成功响应
当删除操作成功执行时，接口返回标准的成功响应格式：

```json
{
  "code": 200,
  "message": "删除成功",
  "data": null,
  "timestamp": 1640995200000
}
```

### 响应字段说明

| 字段 | 类型 | 描述 |
|------|------|------|
| code | Integer | 响应状态码，成功时为200 |
| message | String | 响应消息，成功时为"删除成功" |
| data | Null | 成功时返回null |
| timestamp | Long | 响应时间戳 |

### 错误响应格式
对于各种错误情况，系统返回相应的错误响应：

```json
{
  "code": 404,
  "message": "照片不存在: 123",
  "data": null,
  "timestamp": 1640995200000
}
```

**Section sources**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L275-L285)
- [ApiResponse.java](file://src/main/java/com/photo/dto/ApiResponse.java#L30-L45)

## 错误处理

### 404 Not Found - 照片不存在
当请求的ID不存在于数据库中时，系统返回404错误。

**错误场景**：
- 提供的ID不存在
- 照片已被物理删除
- 照片属于其他用户且已标记为已删除

**错误响应**：
```json
{
  "code": 404,
  "message": "照片不存在: 123",
  "data": null,
  "timestamp": 1640995200000
}
```

### 403 Forbidden - 无权删除
当请求的userId与照片记录中的userId不匹配时，系统返回403错误。

**错误场景**：
- 用户试图删除不属于自己的照片
- 认证信息不正确
- 权限验证失败

**错误响应**：
```json
{
  "code": 403,
  "message": "无权删除该照片",
  "data": null,
  "timestamp": 1640995200000
}
```

### 通用错误处理
系统还处理其他可能的异常情况，如数据库连接问题、文件系统错误等。

**Section sources**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L220-L240)
- [AccessDeniedException.java](file://src/main/java/com/photo/exception/AccessDeniedException.java#L1-L16)

## 使用示例

### curl命令示例

#### 成功删除照片
```bash
curl -X DELETE \
  "https://api.example.com/photos/123?userId=testUser123" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

#### 处理404错误
```bash
curl -X DELETE \
  "https://api.example.com/photos/999?userId=testUser123" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**响应**：
```json
{
  "code": 404,
  "message": "照片不存在: 999",
  "data": null,
  "timestamp": 1640995200000
}
```

#### 处理403错误
```bash
curl -X DELETE \
  "https://api.example.com/photos/123?userId=otherUser456" \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
```

**响应**：
```json
{
  "code": 403,
  "message": "无权删除该照片",
  "data": null,
  "timestamp": 1640995200000
}
```

### JavaScript示例
```javascript
async function deletePhoto(photoId, userId) {
    try {
        const response = await fetch(`/photos/${photoId}?userId=${userId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        const result = await response.json();
        
        if (response.status === 200) {
            console.log('照片删除成功');
            return result;
        } else {
            console.error('删除失败:', result.message);
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('网络错误:', error);
        throw error;
    }
}
```

### Python示例
```python
import requests

def delete_photo(photo_id, user_id, access_token):
    url = f"https://api.example.com/photos/{photo_id}"
    params = {"userId": user_id}
    headers = {
        "Authorization": f"Bearer {access_token}",
        "Content-Type": "application/json"
    }
    
    response = requests.delete(url, params=params, headers=headers)
    
    if response.status_code == 200:
        print("照片删除成功")
        return response.json()
    elif response.status_code == 404:
        print(f"错误: 照片不存在 - {photo_id}")
    elif response.status_code == 403:
        print(f"错误: 无权删除该照片")
    else:
        print(f"错误: {response.status_code} - {response.text}")
    
    return None
```

## 最佳实践

### 参数验证
1. **ID验证**：确保ID为有效的数字类型
2. **用户ID验证**：验证用户身份的有效性
3. **权限检查**：在执行删除前进行权限验证

### 错误处理
1. **优雅降级**：对不同类型的错误提供清晰的错误信息
2. **日志记录**：记录删除操作的详细信息用于审计
3. **用户体验**：提供友好的错误提示信息

### 性能优化
1. **缓存策略**：合理使用缓存减少数据库查询
2. **批量操作**：考虑支持批量删除功能
3. **异步处理**：对于大文件删除可以采用异步处理

### 安全考虑
1. **输入验证**：防止SQL注入和其他攻击
2. **权限隔离**：确保用户只能访问和操作自己的资源
3. **审计跟踪**：记录所有删除操作便于追踪

## 故障排除

### 常见问题及解决方案

#### 问题1：无法删除照片
**症状**：返回404错误或403错误
**原因分析**：
- 照片ID不存在或已被删除
- 用户ID不匹配
- 照片属于其他用户

**解决方案**：
1. 验证照片ID的有效性
2. 确认当前用户的userId正确
3. 检查照片的所有权关系

#### 问题2：权限验证失败
**症状**：返回403错误
**原因分析**：
- 用户认证信息过期或无效
- 请求中的userId与实际用户不匹配
- 系统权限配置问题

**解决方案**：
1. 刷新用户认证令牌
2. 确认请求中的userId正确
3. 检查用户权限配置

#### 问题3：软删除未生效
**症状**：照片仍然可见
**原因分析**：
- 数据库查询条件过滤了已删除的记录
- 缓存未及时更新
- 并发操作冲突

**解决方案**：
1. 检查数据库查询逻辑
2. 清除相关缓存
3. 实现适当的并发控制

### 调试建议
1. **启用详细日志**：开启DEBUG级别日志记录
2. **数据库检查**：直接查询数据库验证删除状态
3. **缓存验证**：检查缓存是否正确清除
4. **权限验证**：验证权限检查逻辑

**Section sources**
- [PhotoControllerTest.java](file://src/test/java/com/photo/controller/PhotoControllerTest.java#L140-L160)