# 数据流

<cite>
**本文档中引用的文件**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java)
- [PhotoRepository.java](file://src/main/java/com/photo/repository/PhotoRepository.java)
- [Photo.java](file://src/main/java/com/photo/entity/Photo.java)
- [FileStorageProperties.java](file://src/main/java/com/photo/config/FileStorageProperties.java)
- [FileUtils.java](file://src/main/java/com/photo/util/FileUtils.java)
- [ImageUtils.java](file://src/main/java/com/photo/util/ImageUtils.java)
- [application.yml](file://src/main/resources/application.yml)
</cite>

## 目录
1. [概述](#概述)
2. [系统架构概览](#系统架构概览)
3. [上传流程数据流](#上传流程数据流)
4. [下载流程数据流](#下载流程数据流)
5. [断点续传流程数据流](#断点续传流程数据流)
6. [组件间交互关系](#组件间交互关系)
7. [数据存储结构](#数据存储结构)
8. [性能优化考虑](#性能优化考虑)
9. [错误处理机制](#错误处理机制)
10. [总结](#总结)

## 概述

本文档详细描述了照片管理系统中的关键业务流程数据流动路径。系统采用Spring Boot架构，主要包含三个核心业务流程：照片上传、照片下载和断点续传下载。每个流程都涉及多个组件之间的协调工作，包括控制器层、服务层、数据访问层和文件存储层。

## 系统架构概览

系统采用分层架构设计，主要分为以下层次：

```mermaid
graph TB
subgraph "表现层"
PC[PhotoController<br/>REST控制器]
end
subgraph "业务逻辑层"
PS[PhotoService<br/>照片业务服务]
FSS[FileStorageService<br/>文件存储服务]
end
subgraph "数据访问层"
PR[PhotoRepository<br/>数据访问接口]
end
subgraph "基础设施层"
FS[文件系统<br/>本地存储]
DB[(数据库<br/>H2/MySQL)]
CACHE[缓存<br/>Caffeine]
end
PC --> PS
PS --> FSS
PS --> PR
FSS --> FS
PR --> DB
PS --> CACHE
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L30-L316)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L35-L385)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L22-L300)
- [PhotoRepository.java](file://src/main/java/com/photo/repository/PhotoRepository.java#L19-L112)

## 上传流程数据流

### 流程概述

上传流程从客户端发起POST /photos/upload请求开始，经过文件验证、存储空间检查、文件存储、缩略图生成和数据库持久化等步骤。

```mermaid
sequenceDiagram
participant Client as 客户端
participant PC as PhotoController
participant PS as PhotoService
participant FSS as FileStorageService
participant PR as PhotoRepository
participant FS as 文件系统
participant DB as 数据库
Client->>PC : POST /photos/upload<br/>MultipartFile file<br/>String userId<br/>String description
PC->>PS : uploadPhoto(file, userId, description)
PS->>PS : validateFile(file)<br/>// 文件类型、大小验证
PS->>PS : checkStorageSpace(fileSize)<br/>// 存储空间检查
PS->>PS : calculateMD5(file)<br/>// 计算文件MD5
PS->>PR : findByMd5(md5)<br/>// 检查重复文件
alt 文件已存在
PR-->>PS : 返回现有照片
PS-->>PC : PhotoUploadResponse
else 新文件
PS->>FSS : storeFile(file)<br/>// 存储原始文件
FSS->>FS : 写入文件到磁盘
FSS-->>PS : storedFilename
PS->>FSS : getFile(storedFilename)<br/>// 获取文件对象
FSS-->>PS : File对象
PS->>PS : getImageDimensions(file)<br/>// 获取图片尺寸
PS->>FSS : createThumbnail(file, storedFilename)<br/>// 创建缩略图
FSS->>FS : 生成缩略图文件
PS->>PS : compressImage(file)<br/>// 压缩图片(可选)
PS->>PR : save(photo)<br/>// 保存元数据到数据库
PR->>DB : 插入照片记录
PR-->>PS : 保存后的Photo对象
PS-->>PC : PhotoUploadResponse
PC-->>Client : 成功响应
end
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L48-L60)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L50-L110)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L58-L94)

### 关键数据流转节点

| 步骤 | 数据流向 | 处理组件 | 数据转换 |
|------|----------|----------|----------|
| 1 | MultipartFile → 验证 | PhotoService.validateFile() | 类型检查、大小验证 |
| 2 | 文件大小 → 存储检查 | PhotoService.checkStorageSpace() | 总存储空间计算 |
| 3 | MultipartFile → MD5 | FileUtils.calculateMD5() | 文件内容哈希计算 |
| 4 | MD5 → 重复检查 | PhotoRepository.findByMd5() | 数据库查询 |
| 5 | MultipartFile → 存储文件 | FileStorageService.storeFile() | 文件写入磁盘 |
| 6 | File → 尺寸获取 | ImageUtils.getImageDimensions() | 图片宽高提取 |
| 7 | File → 缩略图 | ImageUtils.createThumbnail() | 图片压缩处理 |
| 8 | Photo实体 → 数据库 | PhotoRepository.save() | 元数据持久化 |

**章节来源**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L50-L110)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L58-L94)
- [FileUtils.java](file://src/main/java/com/photo/util/FileUtils.java#L106-L118)
- [ImageUtils.java](file://src/main/java/com/photo/util/ImageUtils.java#L21-L47)

## 下载流程数据流

### 流程概述

下载流程从客户端请求GET /photos/download/{filename}开始，系统先获取照片信息并更新下载计数，然后读取文件内容并返回给客户端。

```mermaid
sequenceDiagram
participant Client as 客户端
participant PC as PhotoController
participant PS as PhotoService
participant FSS as FileStorageService
participant PR as PhotoRepository
participant FS as 文件系统
participant DB as 数据库
Client->>PC : GET /photos/download/{filename}
PC->>PS : getPhotoByFilename(filename)<br/>// 获取照片信息
PS->>PR : findByStoredFilename(filename)<br/>// 查询数据库
PR->>DB : SELECT * FROM photos WHERE stored_filename = ?
PR-->>PS : Photo对象
PS-->>PC : Photo对象
PC->>PS : incrementDownloadCount(photoId)<br/>// 更新下载计数
PS->>PR : incrementDownloadCount(id)<br/>// 数据库更新
PR->>DB : UPDATE photos SET download_count = download_count + 1 WHERE id = ?
PC->>FSS : getFile(filename)<br/>// 获取文件
FSS->>FS : 读取文件到内存
FSS-->>PC : File对象
PC->>PC : 读取文件内容<br/>// Files.readAllBytes()
PC->>PC : 设置HTTP响应头<br/>// Content-Type, Content-Disposition
PC-->>Client : 文件二进制流 + HTTP头
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L149-L178)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L155-L160)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L98-L114)

### 下载流程数据转换

```mermaid
flowchart TD
Start([客户端请求下载]) --> ValidateFilename["验证文件名参数"]
ValidateFilename --> GetPhoto["PhotoService.getPhotoByFilename()"]
GetPhoto --> QueryDB["查询数据库获取照片信息"]
QueryDB --> UpdateCount["PhotoService.incrementDownloadCount()"]
UpdateCount --> UpdateDB["数据库更新下载计数"]
UpdateDB --> GetFile["FileStorageService.getFile()"]
GetFile --> ReadFile["读取文件到内存"]
ReadFile --> SetHeaders["设置HTTP响应头"]
SetHeaders --> SendContent["发送文件内容"]
SendContent --> End([响应完成])
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L154-L178)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L246-L250)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L98-L114)

**章节来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L149-L178)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L155-L160)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L98-L114)

## 断点续传流程数据流

### 流程概述

断点续传流程支持HTTP Range请求，允许客户端分段下载大文件。系统需要解析Range头，确定下载范围，然后读取指定范围的文件内容。

```mermaid
sequenceDiagram
participant Client as 客户端
participant PC as PhotoController
participant PS as PhotoService
participant FSS as FileStorageService
participant FS as 文件系统
Client->>PC : GET /photos/download/range/{filename}<br/>Range : bytes=start-end
PC->>PS : getPhotoByFilename(filename)<br/>// 获取照片信息
PS-->>PC : Photo对象
PC->>FSS : getFileSize(filename)<br/>// 获取文件大小
FSS->>FS : 获取文件长度
FSS-->>PC : fileSize
PC->>PC : 解析Range头<br/>// 提取start和end位置
Note over PC : Range : bytes=start-end<br/>start : 起始字节<br/>end : 结束字节
PC->>FSS : readFileRange(filename, start, end)<br/>// 读取文件范围
FSS->>FS : RandomAccessFile.seek(start)<br/>// 定位到起始位置
FSS->>FS : 读取指定长度的内容
FSS-->>PC : byte[] content
PC->>PC : 构建HTTP响应<br/>// 设置状态码、Content-Range头
PC-->>Client : PARTIAL_CONTENT 206 + 文件内容
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L183-L224)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L227-L256)

### Range头解析和处理流程

```mermaid
flowchart TD
Start([接收Range请求]) --> ParseRange["解析Range头<br/>Range: bytes=start-end"]
ParseRange --> ValidateFormat{"格式验证"}
ValidateFormat --> |无效| BadRequest["返回400 Bad Request"]
ValidateFormat --> |有效| ExtractBounds["提取start和end边界"]
ExtractBounds --> ValidateBounds{"边界有效性检查"}
ValidateBounds --> |超出文件大小| BadRequest
ValidateBounds --> |有效| CalculateLength["计算内容长度<br/>length = end - start + 1"]
CalculateLength --> ReadFile["FileStorageService.readFileRange()"]
ReadFile --> SeekPosition["定位到start位置<br/>RandomAccessFile.seek()"]
SeekPosition --> ReadContent["读取指定长度内容"]
ReadContent --> BuildResponse["构建HTTP响应"]
BuildResponse --> SetHeaders["设置响应头<br/>Content-Range, Accept-Ranges"]
SetHeaders --> ReturnPartial["返回206 Partial Content"]
BadRequest --> End([结束])
ReturnPartial --> End
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L196-L211)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L227-L256)

### 断点续传数据处理

| 请求阶段 | 处理内容 | 数据格式 | 输出格式 |
|----------|----------|----------|----------|
| Range头解析 | bytes=start-end | 字符串 | long start, long end |
| 边界验证 | 超出文件大小检查 | 文件大小 | 异常或调整边界 |
| 内容读取 | 指定范围字节 | 文件偏移量 | byte[] content |
| 响应构建 | HTTP状态码和头 | 206 Partial Content | 二进制内容 + HTTP头 |

**章节来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L183-L224)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L227-L256)

## 组件间交互关系

### 依赖关系图

```mermaid
graph TD
subgraph "控制器层"
PC[PhotoController]
end
subgraph "服务层"
PS[PhotoService]
FSS[FileStorageService]
end
subgraph "数据访问层"
PR[PhotoRepository]
end
subgraph "工具类层"
FU[FileUtils]
IU[ImageUtils]
SP[FileStorageProperties]
end
subgraph "配置层"
AC[application.yml]
end
PC --> PS
PC --> FSS
PS --> FSS
PS --> PR
PS --> FU
PS --> IU
FSS --> FU
FSS --> SP
PR --> Photo[Photo实体]
SP --> AC
```

**图表来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L36-L44)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L38-L46)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L26-L28)

### 数据流映射表

| 组件 | 输入参数 | 输出结果 | 主要功能 |
|------|----------|----------|----------|
| PhotoController.uploadPhoto() | MultipartFile, String userId, String description | ResponseEntity<PhotoUploadResponse> | 接收上传请求，调用业务服务 |
| PhotoService.uploadPhoto() | MultipartFile, String userId, String description | PhotoUploadResponse | 文件验证、存储、数据库操作 |
| FileStorageService.storeFile() | MultipartFile | String storedFilename | 文件存储到本地磁盘 |
| PhotoRepository.save() | Photo entity | Photo entity | 数据持久化到数据库 |
| PhotoController.downloadPhoto() | String filename | ResponseEntity<byte[]> | 文件下载，设置HTTP响应 |
| FileStorageService.readFileRange() | String filename, long start, long end | byte[] content | 支持断点续传的文件读取 |

**章节来源**
- [PhotoController.java](file://src/main/java/com/photo/controller/PhotoController.java#L48-L60)
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L50-L110)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L58-L94)

## 数据存储结构

### 照片实体模型

```mermaid
erDiagram
PHOTO {
bigint id PK
varchar original_filename
varchar stored_filename UK
varchar file_path
varchar thumbnail_path
bigint file_size
varchar content_type
varchar extension
int width
int height
varchar md5 UK
varchar user_id
bigint access_count
bigint download_count
boolean is_public
boolean deleted
text description
datetime created_at
datetime updated_at
datetime last_accessed_at
varchar ip_address
}
```

**图表来源**
- [Photo.java](file://src/main/java/com/photo/entity/Photo.java#L17-L174)

### 存储配置结构

| 配置项 | 默认值 | 说明 |
|--------|--------|------|
| basePath | ./uploads | 文件存储根目录 |
| tempPath | ./uploads/temp | 临时文件目录 |
| thumbnailPath | ./uploads/thumbnails | 缩略图存储目录 |
| maxFileSize | 10MB | 单文件最大大小 |
| maxStorageSize | 10GB | 总存储空间限制 |
| maxFilesPerUpload | 10 | 单次最多上传文件数 |
| thumbnail.width | 200px | 缩略图宽度 |
| thumbnail.height | 200px | 缩略图高度 |
| compression.enabled | true | 是否启用图片压缩 |

**章节来源**
- [FileStorageProperties.java](file://src/main/java/com/photo/config/FileStorageProperties.java#L20-L65)
- [application.yml](file://src/main/resources/application.yml#L54-L98)

## 性能优化考虑

### 缓存策略

系统实现了多层缓存机制来提升性能：

1. **照片信息缓存**：使用`@Cacheable`注解缓存照片元数据
2. **存储信息缓存**：缓存存储空间使用情况
3. **缩略图缓存**：避免重复生成缩略图

### 并发处理

- **事务管理**：使用`@Transactional`确保数据一致性
- **文件并发安全**：文件存储采用原子操作
- **数据库连接池**：合理配置连接池参数

### 内存管理

- **大文件处理**：断点续传支持大文件分段下载
- **临时文件清理**：定期清理临时文件
- **垃圾回收优化**：合理控制内存使用

## 错误处理机制

### 异常分类和处理

```mermaid
flowchart TD
Request[客户端请求] --> Validation{参数验证}
Validation --> |失败| ParamError[参数异常<br/>FileTypeException<br/>FileSizeException]
Validation --> |成功| BusinessLogic[业务逻辑处理]
BusinessLogic --> FileOp{文件操作}
FileOp --> |失败| FileError[文件异常<br/>FileStorageException<br/>FileNotFoundException]
BusinessLogic --> DBOp{数据库操作}
DBOp --> |失败| DBError[数据库异常<br/>DataAccessException]
BusinessLogic --> Success[正常处理]
ParamError --> ErrorHandler[全局异常处理器]
FileError --> ErrorHandler
DBError --> ErrorHandler
Success --> Response[返回响应]
ErrorHandler --> ErrorResponse[返回错误响应]
```

**图表来源**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L302-L336)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L58-L94)

### 错误响应格式

| 异常类型 | HTTP状态码 | 错误消息示例 |
|----------|------------|--------------|
| FileTypeException | 400 | "只允许上传图片文件" |
| FileSizeException | 400 | "文件大小不能超过 10MB" |
| StorageFullException | 400 | "存储空间不足" |
| FileNotFoundException | 404 | "照片不存在" |
| FileStorageException | 500 | "文件存储失败" |

**章节来源**
- [PhotoService.java](file://src/main/java/com/photo/service/PhotoService.java#L302-L336)
- [FileStorageService.java](file://src/main/java/com/photo/service/FileStorageService.java#L58-L94)

## 总结

本文档详细分析了照片管理系统的核心数据流，涵盖了上传、下载和断点续传三大业务流程。系统采用分层架构设计，通过清晰的职责分离实现了高效的数据处理能力。

### 关键特性

1. **完整的文件生命周期管理**：从上传到存储再到清理的全流程控制
2. **智能文件去重**：基于MD5的重复文件检测机制
3. **灵活的存储策略**：支持多种图片格式和压缩配置
4. **高性能的并发处理**：事务管理和缓存机制保证系统稳定性
5. **完善的错误处理**：多层次的异常捕获和响应机制

### 技术亮点

- **断点续传支持**：HTTP Range请求处理，提升大文件下载体验
- **缩略图自动生成**：自动创建适合Web显示的缩略图
- **存储空间监控**：实时监控和预警存储使用情况
- **定期清理机制**：自动清理过期文件，保持系统整洁

该系统为照片管理提供了稳定、高效的解决方案，能够满足现代应用对文件处理的各种需求。